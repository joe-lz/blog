{"ast":null,"code":"var __jsx = React.createElement;\nimport Head from 'next/head';\nimport Link from 'next/link';\nimport React, { useState, useEffect } from 'react';\nimport AV from 'leancloud-storage';\nimport dynamic from 'next/dynamic';\nimport shortid from 'shortid';\nimport styles from './index.module.scss';\nconst Nav = dynamic(() => import('src/components/admin/Nav'), {\n  ssr: false,\n  loadableGenerated: {\n    webpack: () => [require.resolveWeak('src/components/admin/Nav')],\n    modules: ['src/components/admin/Nav']\n  }\n});\nconst Login = dynamic(() => import('src/components/admin/Login'), {\n  ssr: false,\n  loadableGenerated: {\n    webpack: () => [require.resolveWeak('src/components/admin/Login')],\n    modules: ['src/components/admin/Login']\n  }\n});\nconst BodyContent = dynamic(() => import('src/components/admin/BodyContent'), {\n  ssr: false,\n  loadableGenerated: {\n    webpack: () => [require.resolveWeak('src/components/admin/BodyContent')],\n    modules: ['src/components/admin/BodyContent']\n  }\n});\nimport { createProfile, getProfileList, updateProfile } from 'src/service/profile';\nimport { getMyUserInfo } from 'src/service/user';\nComponents.defaultProps = {\n  onChange: () => {},\n  hideSidebar: false,\n  bodyStyle: {}\n};\n\nfunction Components(props) {\n  const {\n    0: curUser,\n    1: setcurUser\n  } = useState(AV.User.current());\n  const {\n    0: userinfo,\n    1: setuserinfo\n  } = useState(null);\n  const {\n    0: profile,\n    1: setprofile\n  } = useState(null); // 获取博客设置资料\n\n  const getProfile = () => {\n    getProfileList().then(res => {\n      if (res) {\n        setprofile(res);\n      } else {\n        createProfile().then(resCreate => {\n          setprofile(resCreate);\n        });\n      }\n    });\n  }; // 获取当前用户资料\n\n\n  const fetchUserInfo = async () => {\n    const res_userinfo = await getMyUserInfo();\n\n    if (res_userinfo) {\n      setuserinfo(res_userinfo);\n    } else {\n      // 创建userinfo\n      const userinfoObj = new AV.Object('CMS_UserInfo');\n      userinfoObj.set('user', curUser);\n      userinfoObj.set('nickname', curUser.toJSON().username);\n      userinfoObj.set('priority', 1); // 权限等级 默认：1 未授权\n\n      userinfoObj.set('shortid', shortid.generate()); // shortid\n      // 将对象保存到云端\n\n      userinfoObj.save().then(todo => {\n        // 成功保存之后，执行其他逻辑\n        fetchUserInfo();\n      }, error => {// 异常处理\n      });\n    }\n  };\n\n  useEffect(() => {\n    getProfile();\n\n    if (curUser) {\n      fetchUserInfo();\n    }\n  }, []);\n  useEffect(() => {\n    props.onChange && props.onChange({\n      curUser,\n      profile,\n      userinfo\n    });\n  }, [curUser, profile, userinfo]);\n  return __jsx(\"div\", {\n    className: styles.container\n  }, __jsx(Head, null, __jsx(\"title\", null, \"\\u7BA1\\u7406\\u540E\\u53F0\")), __jsx(Nav, {\n    type: \"login\",\n    curUser: curUser,\n    userinfo: userinfo,\n    profile: profile\n  }), __jsx(\"div\", {\n    className: styles.body,\n    style: props.bodyStyle\n  }, !curUser && __jsx(Login, {\n    profile: profile\n  }), curUser && __jsx(BodyContent, {\n    priority: userinfo ? userinfo.toJSON().priority : 0,\n    userinfo: userinfo,\n    hideSidebar: props.hideSidebar\n  }, props.children)));\n}\n\nexport default Components;","map":null,"metadata":{},"sourceType":"module"}